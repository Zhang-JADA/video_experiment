<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Watch Video</title>
</head>
<body>
  <video id="videoPlayer" width="640" controls>
    <source src="" type="video/mp4">
    Your browser does not support video playback.
  </video>

  <script>
    // Prevent going back to the choice page
    if (window.history && window.history.pushState) {
      window.history.pushState(null, null, window.location.href);
      window.onpopstate = function () {
        window.history.go(1);
      };
    }

    // Load chosen video data
    const choiceData = JSON.parse(localStorage.getItem('choiceData'));
    const video = document.getElementById('videoPlayer');
    video.querySelector('source').src = choiceData.chosen_video;
    video.load();

    // Variables for logging
    let startTime, endTime;
    let pauseCount = 0;
    let seekCount = 0;
    let maxWatchTime = 0;

    video.addEventListener('play', () => {
      if (!startTime) startTime = new Date();
    });

    video.addEventListener('pause', () => {
      pauseCount++;
    });

    video.addEventListener('seeked', () => {
      seekCount++;
    });

    video.addEventListener('timeupdate', () => {
      if (video.currentTime > maxWatchTime) {
        maxWatchTime = video.currentTime;
      }
    });

    video.addEventListener('ended', () => {
      endTime = new Date();
      uploadLog();
    });

    window.addEventListener('beforeunload', () => {
      if (!endTime) endTime = new Date();
      uploadLog();
    });

    // Upload log to Google Sheets
    function uploadLog() {
      const watchPercentage = video.duration ? ((maxWatchTime / video.duration) * 100).toFixed(2) + '%' : null;

      const logData = {
        ...choiceData,
        video_start_time: startTime ? startTime.toISOString() : null,
        video_end_time: endTime ? endTime.toISOString() : null,
        watch_duration: endTime && startTime ? Math.round((endTime - startTime) / 1000) : null,
        video_completed: video.ended,
        pause_count: pauseCount,
        seek_count: seekCount,
        watch_percentage: watchPercentage
      };

      fetch("https://script.google.com/macros/s/AKfycbzwx93JeHyetigJnZhfMlue4rswP7xcl_IomOsA7faBV5n3CXGw2jygRkqm-Kllq8XI/exec", {
        method: "POST",
        body: JSON.stringify(logData),
        headers: { "Content-Type": "application/json" }
      })
      .then(response => response.text())
      .then(data => {
        console.log("Log successfully uploaded to Google Sheets");
      })
      .catch(error => {
        console.error("Upload failed:", error);
      });
    }
  </script>
</body>
</html>